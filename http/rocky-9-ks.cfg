# Generated by pykickstart v3.32
#version=ROCKY9
# Use text install
text --non-interactive

# Once install is finished, reboot
reboot
eula --agreed

%addon com_redhat_kdump --disable

%end

# Keyboard layouts
keyboard --xlayouts='us'
# System language
lang en_US.UTF-8

# Network information
network  --bootproto=dhcp --device=link --noipv6 --activate
network  --hostname=localhost.localdomain

# Configure firewall settings for the system (optional)
# --enabled	reject incoming connections that are not in response to outbound requests
# --ssh		allow sshd service through the firewall
firewall --enabled --ssh

# State of SELinux on the installed system (optional)
# Defaults to enforcing
selinux --enforcing

%packages
@^minimal-environment
cloud-init
vim 
tmux
qemu-guest-agent
lsof
aide
bash-completion
yum-utils
tar
unzip
-iw*-firmware

%end

# Disable the Setup Agent on first boot
firstboot --disable

ignoredisk --only-use=sda

# Specify how the bootloader should be installed (required)
# Refer to e.g.
#   grub2-mkpasswd-pbkdf2
# to see how to create encrypted password form for different plaintext password
bootloader --location=mbr --boot-drive=sda --append="fips=0 audit=1 audit_backlog_limit=8192 slub_debug=P page_poison=1 vsyscall=none" --password=grub.pbkdf2.sha512.10000.45912D32B964BA58B91EAF9847F3CCE6F4C962638922543AFFAEE4D29951757F4336C181E6FC9030E07B7D9874DAD696A1B18978D995B1D7F27AF9C38159FDF3.99F65F3896012A0A3D571A99D6E6C695F3C51BE5343A01C1B6907E1C3E1373CB7F250C2BC66C44BB876961E9071F40205006A05189E51C2C14770C70C723F3FD --iscrypted

# Partition clearing information
clearpart --all --initlabel

# Disk partitioning information
part pv.01 --fstype=lvmpv --ondisk=sda --size=1024 --grow 
part /boot --fstype=xfs   --ondisk=sda --size=512   --fsoptions="nodev,nosuid,noexec"

# Create a Logical Volume Management group
volgroup rl --pesize=4096 pv.01

# Create particular logical volumes
logvol /              --fstype=xfs  --name=root          --vgname=rl --size=4096 --grow
logvol /home          --fstype=xfs  --name=home          --vgname=rl --size=4096  --fsoptions="nodev,nosuid"
logvol swap           --fstype=swap --name=swap          --vgname=rl --size=2048 

# System timezone
timezone UTC --utc

# Root password
rootpw --iscrypted $6$y0ToQj4FDojgwNAj$ph7LNdS5jpKo5O6pe24c634SYSQbX4O47SHDNSieX85TIhP1Z2GzaxxIKtXSDh7pHDeepl2dR42BlAfRAMGzc/
user --groups=wheel --name=ansible --password=$6$.2i5MdbXa5RDnJrB$zWHZQ6RCFCdM3k3h0naVQzTDqjJBq4SWVmkwOXh3hV/UeYGa3xrSMyvf71bUXXmVm77mmzuoBUCJAbVhoYaS80 --iscrypted --gecos="ansible"
sshkey --username=ansible "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDQdZaNi93Sv5Uo6duHVBnK2L8MeyGI0kcjvJOBfDZjjfLFtkjYIvuhxwnGNJtJl2kNulYJWZFUDlS6WjqferzdQdGPrLS22vZO+5anKHpXKrGy1TtJqQ8bY/RfRT+AtljFnAQ4m/tXIZ8aRkMUk4TdKpL6ndoJ1c/DEvNrw+Vty5P4cgi4Xsw9I6v0jViXOH8LkBTzHJXBN9J0PmEPpS50nsNhZ1Yd4BGwkAv0iuowL2KQSU83xdDoIXhIuPM6fVbBO8HlFGu/t3H7nwjinshJ1bCBR5Z4gn0A2hT4PRnfbmfuhA9PDEXL5bl8/Cp3YJEPmR4sI++Ex1hLMTZVIvF5 ivarela@ivarela-mac"

# --- ADDED FOR PACKER AUTOMATION ---
%post --log=/var/log/post_install.log
# Ensure ansible user has NOPASSWD sudo access for the provisioning script
echo "ansible ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/ansible
chmod 0440 /etc/sudoers.d/ansible

# Enable QEMU agent so Proxmox can see the IP address
systemctl enable qemu-guest-agent
%end
